<?php

require_once $rootPath.'/vendor/Adroframework/Bash/Module/Module.php';

class App
{
    const ROOT_APP_DIRECTORY        = 'application';
    const APP_CONFIG_DIRECTORY      = 'configs';
    const APP_MODULES_DIRECTORY     = 'modules';
    const APP_CONFIG_FILE_NAME      = 'application.config';
    const APP_DB_CONFIG_DIRECTORY   = 'db';
    const APP_DB_CONFIG_FILE_NAME   = 'db.adapter.config';

    protected $moduleCreation;
    protected $rootPath;

    public function __construct($rootPath = null)
    {
        if (null === $rootPath) {
            die("Invalid path");
        }
        $this->rootPath = $rootPath;
        $this->moduleCreation = new Module($rootPath);
    }

    public function createApp()
    {
        $this->createMainDirectories();        
        $this->createApplicationConfigFile();
        $this->createDbConfigFile();
        $this->createModule();
    }

    protected function createMainDirectories()
    {
        try {
            if (!file_exists ( $this->rootPath.'/'.self::ROOT_APP_DIRECTORY) ) {
                mkdir($this->rootPath.'/'.self::ROOT_APP_DIRECTORY);
            }
            if (!file_exists ( $this->rootPath.'/'.self::ROOT_APP_DIRECTORY.'/'.self::APP_CONFIG_DIRECTORY) ) {
                mkdir($this->rootPath.'/'.self::ROOT_APP_DIRECTORY.'/'.self::APP_CONFIG_DIRECTORY);
            }
            if (!file_exists ( $this->rootPath.'/'.self::ROOT_APP_DIRECTORY.'/'.self::APP_CONFIG_DIRECTORY.'/'.self::APP_DB_CONFIG_DIRECTORY) ) {
                mkdir($this->rootPath.'/'.self::ROOT_APP_DIRECTORY.'/'.self::APP_CONFIG_DIRECTORY.'/'.self::APP_DB_CONFIG_DIRECTORY);
            }
            if (!file_exists ( $this->rootPath.'/'.self::ROOT_APP_DIRECTORY.'/'.self::APP_MODULES_DIRECTORY) ) {
                mkdir($this->rootPath.'/'.self::ROOT_APP_DIRECTORY.'/'.self::APP_MODULES_DIRECTORY);
            }
        } catch (Exception $e) {
            echo 'Caught exception: ',  $e->getMessage(), "\n";
        }
    }

    protected function createApplicationConfigFile()
    {
        try {
            if (file_exists ( $this->rootPath.'/'.self::ROOT_APP_DIRECTORY.'/'.self::APP_CONFIG_DIRECTORY.'/'.self::APP_CONFIG_FILE_NAME.'.php' )) {
                die("Config file exist, this is not a clean creation of new application\n");
            }
            $content = "<?php \n"
                        ."/**\n"
                        ." * Application configuration\n"
                        ." * This was autogenerated by the adrofw cli helper\n"
                        ." * If you add a module manually, add it's configuration here.\n"
                        ." */\n\n"
                        ."return array(\n"
                        ."    'modules' => array(\n"
                        ."       'main' => array(\n"
                        ."            'defaults' => array(\n"
                        ."                'layout'        => 'layout',\n"
                        ."                'controller'    => 'index',\n"
                        ."                'action'        => 'index'\n"
                        ."            ),\n"
                        ."            'view_manager' => array(\n"
                        ."                'doctype'                  => 'HTML5',\n"
                        ."                'not_found_template'       => 'error/404',\n"
                        ."                'exception_template'       => 'error/index',\n"
                        ."                'template_path_stack' => array(\n"
                        ."                    __DIR__ . '/../views',\n"
                        ."                ),\n"
                        ."            ),\n"
                        ."        ),\n"
                        ."    ),\n"
                        .");";
            $file = $this->rootPath.'/'.self::ROOT_APP_DIRECTORY.'/'.self::APP_CONFIG_DIRECTORY.'/'.self::APP_CONFIG_FILE_NAME.'.php';
            file_put_contents($file, $content);
        } catch (Exception $e) {
            echo 'Caught exception: ',  $e->getMessage(), "\n";
        }
    }

    protected function createDbConfigFile()
    {
        try {
            if (file_exists ( $this->rootPath.'/'.self::ROOT_APP_DIRECTORY.'/'.self::APP_CONFIG_DIRECTORY.'/'.self::APP_DB_CONFIG_DIRECTORY.'/'.self::APP_DB_CONFIG_FILE_NAME.'.php' )) {
                die("Config file exist, this is not a clean creation of new application\n");
            }
            $content = "<?php \n"
                        ."/**\n"
                        ." * Db Adater configuration file\n"
                        ." * This was autogenerated by the adrofw cli helper\n"
                        ." * By default this return an emty array.\n"
                        ." */\n\n"
                        ."return array();";
            $file = $this->rootPath.'/'.self::ROOT_APP_DIRECTORY.'/'.self::APP_CONFIG_DIRECTORY.'/'.self::APP_DB_CONFIG_DIRECTORY.'/'.self::APP_DB_CONFIG_FILE_NAME.'.php';
            file_put_contents($file, $content);
        } catch (Exception $e) {
            echo 'Caught exception: ',  $e->getMessage(), "\n";
        }
    }

    protected function createModule()
    {
        $this->moduleCreation->createModule('main');
    }
}